<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moonstone List Generator</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BYBM86ZXL3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-BYBM86ZXL3');
  </script>

  <style>
    .card { @apply bg-white/80 backdrop-blur rounded-2xl shadow p-5; }
    .pill { @apply inline-block px-3 py-1 rounded-full text-xs font-medium bg-gray-100; }
    .mono { font-variant-numeric: tabular-nums; }
    details > summary { cursor: pointer; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-200 text-slate-800">
  <div class="max-w-3xl mx-auto px-4 py-8 space-y-6">
    <header class="space-y-2">
      <h1 class="text-3xl font-bold">Moonstone List Generator</h1>
      <p class="text-slate-600">Pick a faction (or Random), generate three sets, and list only characters valid for that faction. Optional: require a healer to be included. If needed, extra sets are added only to reach at least 8 characters. Murder Bunnies, Psychopomps, and Anya/Striga Anya handled automatically.</p>
    </header>

    <section class="card space-y-4">
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-end">
        <div class="grow">
          <label class="block text-sm font-semibold mb-1" for="factionSelect">Faction</label>
          <select id="factionSelect" class="w-full rounded-lg border px-3 py-2">
            <option disabled selected>Loading factions…</option>
          </select>
        </div>
        <div class="shrink-0 flex gap-2">
          <button id="generateBtn" class="rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2.5 disabled:opacity-50">Generate</button>
          <button id="rerollBtn" class="rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold px-5 py-2.5 disabled:opacity-50">Re-roll</button>
        </div>
      </div>
      <label class="flex items-center gap-2 text-sm">
        <input type="checkbox" id="healerMandatory" />
        Healer mandatory
      </label>
      <p class="text-xs text-slate-500">Data source: <code class="mono">models.csv</code> in this folder (headers: Set, Character, Faction, Faction 2, Healer).</p>
    </section>

    <section id="results" class="space-y-6 hidden">
      <div id="note" class="hidden p-3 rounded-lg bg-amber-100 text-amber-900 text-sm"></div>

      <div class="card space-y-2">
        <h2 class="text-xl font-semibold">Chosen Sets</h2>
        <div id="chosenSets" class="flex flex-wrap gap-2"></div>
      </div>

      <div class="card space-y-2">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Characters (<span id="charCount">0</span>)</h2>
          <button id="copyBtn" class="text-sm px-3 py-1 rounded-lg border hover:bg-slate-50">Copy list</button>
        </div>
        <ul id="characterList" class="list-disc pl-6 space-y-1"></ul>
      </div>

      <details class="card">
        <summary class="text-sm font-semibold">Debug info</summary>
        <div id="debug" class="mt-3 text-xs whitespace-pre-wrap font-mono"></div>
      </details>
    </section>

    <footer class="text-xs text-slate-500 pt-8">
      © Moonstone tools — List Generator.
    </footer>
  </div>

  <script>
    /**********************
     * Constants & State
     **********************/
    const CSV_URL = 'models.csv';
    const FACTION_WHITELIST = ['Commonwealth','Leshavult','Dominion','Shades'];
    const EXCLUDED_KEYWORDS = ['bunny', 'urchin', 'sprog', 'pookie', 'jeremy', 'lampy', 'terrible musician', 'teacake', 'pidge', 'flay, bearer' ];
    const ANYA_ALIASES = ['anya', 'striga anya', 'anya / striga anya'];
    const RANDOM_LABEL = 'Random';

    const state = { rows: [], bySet: new Map(), discoveredFactions: new Set(), lastResult: null };
    const $ = (id) => document.getElementById(id);

    /**********************
     * Helpers
     **********************/
    const norm = (s) => (s||'').trim().toLowerCase();
    function splitTokens(val){ return (val||'').split(/[\\/,;&|]/).map(v=>v.trim()).filter(Boolean); }
    function isExcludedCharacter(name){ return EXCLUDED_KEYWORDS.some(k => norm(name).includes(k)); }
    function mergeAnyaGlobally(chars){ return chars.some(c=>ANYA_ALIASES.includes(norm(c))) ? [...chars.filter(c=>!ANYA_ALIASES.includes(norm(c))), 'Anya / Striga Anya'] : chars; }
    function uniquePreserve(arr){ const seen=new Set(), out=[]; for(const x of arr){ if(!seen.has(norm(x))){ seen.add(norm(x)); out.push(x); } } return out; }
    function pickRandom(arr,n){ const c=arr.slice(); for(let i=c.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]];} return c.slice(0,n); }
    function chooseFaction(req){ if(req===RANDOM_LABEL){ const pool=[...state.discoveredFactions].filter(f=>FACTION_WHITELIST.includes(f)); return pool[Math.floor(Math.random()*pool.length)]||FACTION_WHITELIST[0]; } return req; }

    /**********************
     * CSV load
     **********************/
    async function loadCSV(){
      const res=await fetch(CSV_URL,{cache:'no-store'}); const text=await res.text();
      const parsed=Papa.parse(text,{header:true,skipEmptyLines:'greedy'});
      const rows=[]; const bySet=new Map(); const discovered=new Set();
      for(const r of parsed.data){
        const set=(r['Set']||'').trim(); const char=(r['Character']||'').trim();
        if(!set||!char) continue;
        const factions=[...splitTokens(r['Faction']),...splitTokens(r['Faction 2'])];
        factions.forEach(f=>discovered.add(f));
        const healer=norm(r['Healer'])==='yes';
        const row={Set:set,Character:char,factions,Healer:healer};
        rows.push(row);
        if(!bySet.has(set)) bySet.set(set,[]); bySet.get(set).push(row);
      }
      state.rows=rows; state.bySet=bySet; state.discoveredFactions=discovered;
    }
    function populateFactionDropdown(){
      const fs=$('factionSelect'); fs.innerHTML='';
      const optR=document.createElement('option'); optR.value=RANDOM_LABEL; optR.textContent=RANDOM_LABEL; fs.appendChild(optR);
      const list=FACTION_WHITELIST.filter(f=>state.discoveredFactions.has(f));
      for(const f of (list.length?list:[...state.discoveredFactions])){
        const opt=document.createElement('option'); opt.value=f; opt.textContent=f; fs.appendChild(opt);
      }
    }

    /**********************
     * Core logic
     **********************/
    function charactersForSetAndFaction(set,faction){
      const rows=state.bySet.get(set)||[];
      return rows.filter(r=>r.factions.map(norm).includes(norm(faction))).map(r=>r.Character).filter(c=>c&&!isExcludedCharacter(c));
    }
    function healerInSetForFaction(set,faction){
      const rows=state.bySet.get(set)||[];
      return rows.some(r=>r.factions.map(norm).includes(norm(faction)) && r.Healer);
    }
    function eligibleSetsForFaction(faction){
      return [...state.bySet.keys()].filter(set=>charactersForSetAndFaction(set,faction).length>0);
    }
    function generateList(reqFaction){
      const faction=chooseFaction(reqFaction); const healerMandatory=$('healerMandatory').checked;
      let elig=eligibleSetsForFaction(faction);
      if(!elig.length) return {faction,sets:[],characters:[],addedExtra:false,message:'No sets for faction'};
      const firstTwo=pickRandom(elig,Math.min(2,elig.length)); let chosen=[...firstTwo];
      const hasHealer=state.rows.some(r=>chosen.includes(r.Set)&&r.Healer&&r.factions.map(norm).includes(norm(faction)));
      let thirdPool=elig.filter(s=>!chosen.includes(s));
      if(healerMandatory && !hasHealer){ thirdPool=thirdPool.filter(s=>healerInSetForFaction(s,faction)); }
      if(thirdPool.length){ chosen.push(pickRandom(thirdPool,1)[0]); }
      let allChars=chosen.flatMap(s=>charactersForSetAndFaction(s,faction));
      let addedExtra=false; let remaining=elig.filter(s=>!chosen.includes(s));
      while(allChars.length<8 && remaining.length){ addedExtra=true; const next=pickRandom(remaining,1)[0]; chosen.push(next); remaining=remaining.filter(x=>x!==next); allChars.push(...charactersForSetAndFaction(next,faction)); }
      allChars=uniquePreserve(mergeAnyaGlobally(allChars));
      const healerIncluded=allChars.some(c=>{const r=state.rows.find(row=>row.Character===c&&row.Healer);return r&&r.factions.map(norm).includes(norm(faction));});
      return {faction,sets:chosen,characters:allChars,addedExtra,message:(healerMandatory&&!healerIncluded)?'Could not satisfy healer requirement':''};
    }

    /**********************
     * Render
     **********************/
    function renderResult(r,req){
      $('results').classList.remove('hidden');
      if(r.addedExtra){ $('note').textContent='Added extra sets to reach at least 8 characters.'; $('note').classList.remove('hidden'); }
      else if(r.message){ $('note').textContent=r.message; $('note').classList.remove('hidden'); }
      else $('note').classList.add('hidden');

      $('chosenSets').innerHTML='';
      r.sets.forEach(s=>{
        const span=document.createElement('span');
        span.className='pill';
        span.textContent=s;
        $('chosenSets').appendChild(span);
      });

      $('characterList').innerHTML='';
      r.characters.forEach(c=>{
        const li=document.createElement('li');
        const healerRow = state.rows.find(row =>
          row.Character === c &&
          row.Healer &&
          row.factions.map(norm).includes(norm(r.faction))
        );
        if (healerRow) {
          li.innerHTML = `<span class="text-green-700 font-semibold">✚ ${c}</span>`;
        } else {
          li.textContent = c;
        }
        $('characterList').appendChild(li);
      });
      $('charCount').textContent=r.characters.length;

      $('debug').textContent=`Requested: ${req}\nChosen faction: ${r.faction}\nSets: ${r.sets.length}\nCharacters: ${r.characters.length}`;
    }
    function copyList(){ const items=[...document.querySelectorAll('#characterList li')].map(li=>'• '+li.textContent); const sets=[...document.querySelectorAll('#chosenSets span')].map(s=>s.textContent); const txt=['Moonstone List Generator','','Sets:',...sets.map(s=>'- '+s),'',`Characters (${items.length}):`,...items].join('\n'); navigator.clipboard.writeText(txt).then(()=>{ $('copyBtn').textContent='Copied!'; setTimeout(()=>$('copyBtn').textContent='Copy list',1200); }); }

    /**********************
     * Init
     **********************/
    $('copyBtn').addEventListener('click',copyList);
    function run(){ const req=$('factionSelect').value; const r=generateList(req); renderResult(r,req);}
    $('generateBtn').addEventListener('click',run); $('rerollBtn').addEventListener('click',run);
    (async function init(){ await loadCSV(); populateFactionDropdown(); $('generateBtn').disabled=false; $('rerollBtn').disabled=false; })();
  </script>
</body>
</html>




